<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recording Indicator</title>
    <style>
      :root {
        --panel-bg: #ffffff;
        --panel-border: #e5e5e5;
        --text-main: #1a1a1a;
        --text-subtle: #999999;
        --recording: #ef4444;
        --processing: #f59e0b;
        --complete: #22c55e;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        overflow: hidden;
        user-select: none;
        font-family: Inter, 'Segoe UI', sans-serif;
      }

      .indicator {
        display: none;
        align-items: center;
        gap: 10px;
        width: fit-content;
        max-width: 220px;
        margin: 8px auto;
        padding: 10px 16px;
        border-radius: 12px;
        border: 1px solid var(--panel-border);
        background: var(--panel-bg);
      }

      .indicator.visible {
        display: inline-flex;
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--recording);
        animation: pulse 1s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.35;
        }
      }

      .icon {
        width: 18px;
        height: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .icon svg {
        width: 18px;
        height: 18px;
      }

      .text {
        font-size: 14px;
        font-weight: 500;
        line-height: 1;
        color: var(--text-main);
        white-space: nowrap;
      }

      .meta {
        font-size: 13px;
        line-height: 1;
        color: var(--text-subtle);
        white-space: nowrap;
      }

      .hotkey {
        display: inline-flex;
        align-items: center;
        border: 1px solid #e5e5e5;
        background: #f3f4f6;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 11px;
        font-weight: 500;
        line-height: 1;
        color: #6b7280;
        white-space: nowrap;
      }

      .proc-dots {
        display: none;
        align-items: center;
        gap: 4px;
      }

      .proc-dots span {
        width: 5px;
        height: 5px;
        border-radius: 999px;
      }

      .proc-dots span:nth-child(1) {
        background: #f59e0b;
      }

      .proc-dots span:nth-child(2) {
        background: #fcd34d;
      }

      .proc-dots span:nth-child(3) {
        background: #fef3c7;
      }

      .state-recording .icon-mic {
        display: inline-flex;
        color: var(--recording);
      }

      .state-recording .icon-loader,
      .state-recording .icon-check {
        display: none;
      }

      .state-recording .meta,
      .state-recording .hotkey,
      .state-recording .dot {
        display: inline-flex;
      }

      .state-recording .proc-dots {
        display: none;
      }

      .state-processing .icon-loader {
        display: inline-flex;
        color: var(--processing);
        animation: spin 0.9s linear infinite;
      }

      .state-processing .icon-mic,
      .state-processing .icon-check,
      .state-processing .dot,
      .state-processing .meta,
      .state-processing .hotkey {
        display: none;
      }

      .state-processing .proc-dots {
        display: inline-flex;
      }

      .state-complete .icon-check {
        display: inline-flex;
        color: var(--complete);
      }

      .state-complete .icon-mic,
      .state-complete .icon-loader,
      .state-complete .dot,
      .state-complete .hotkey,
      .state-complete .proc-dots {
        display: none;
      }

      .state-complete .meta {
        display: inline-flex;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="indicator" class="indicator">
      <span class="dot"></span>

      <span class="icon icon-mic" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9">
          <path d="M12 3a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V6a3 3 0 0 0-3-3Z" />
          <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
          <path d="M12 19v3" />
        </svg>
      </span>

      <span class="icon icon-loader" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9">
          <path d="M21 12a9 9 0 1 1-6.2-8.56" />
        </svg>
      </span>

      <span class="icon icon-check" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9">
          <circle cx="12" cy="12" r="9" />
          <path d="m8.5 12 2.2 2.2L15.8 9" />
        </svg>
      </span>

      <span id="statusText" class="text">Recording...</span>
      <span id="metaText" class="meta">0:00</span>
      <span id="hotkeyText" class="hotkey">R Ctrl</span>

      <span class="proc-dots" aria-hidden="true">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>

    <script>
      const indicator = document.getElementById('indicator')
      const statusText = document.getElementById('statusText')
      const metaText = document.getElementById('metaText')
      const hotkeyText = document.getElementById('hotkeyText')

      let timer = null
      let seconds = 0
      let lastCharCount = 0
      let lastState = 'idle'
      let completeTimer = null
      let feedbackTimer = null

      function formatSeconds(total) {
        const minutes = Math.floor(total / 60)
        const secs = total % 60
        return `${minutes}:${String(secs).padStart(2, '0')}`
      }

      function setIndicatorState(state) {
        indicator.className = 'indicator visible'
        indicator.classList.add(`state-${state}`)
      }

      function hideIndicator() {
        indicator.className = 'indicator'
      }

      function clearTimers() {
        if (timer) {
          clearInterval(timer)
          timer = null
        }
        if (completeTimer) {
          clearTimeout(completeTimer)
          completeTimer = null
        }
        if (feedbackTimer) {
          clearTimeout(feedbackTimer)
          feedbackTimer = null
        }
      }

      function toHotkeyLabel(triggerKey) {
        if (!triggerKey) return 'R Ctrl'
        if (triggerKey === 'RCtrl') return 'R Ctrl'
        if (triggerKey === 'RAlt') return 'R Alt'
        return triggerKey
      }

      async function loadHotkey() {
        try {
          const config = await window.api.getConfig()
          const triggerKey = config?.hotkey?.triggerKey
          hotkeyText.textContent = toHotkeyLabel(triggerKey)
        } catch {
          hotkeyText.textContent = 'R Ctrl'
        }
      }

      void loadHotkey()

      window.api.onOutputText(({ text }) => {
        lastCharCount = String(text || '').length
      })

      window.api.onRecordingState((state) => {
        if (state.recording) {
          clearTimers()
          lastState = 'recording'
          seconds = 0
          statusText.textContent = 'Recording...'
          metaText.textContent = '0:00'
          setIndicatorState('recording')
          timer = setInterval(() => {
            seconds += 1
            metaText.textContent = formatSeconds(seconds)
          }, 1000)
          return
        }

        if (state.processing) {
          clearTimers()
          lastState = 'processing'
          statusText.textContent = 'Transcribing...'
          setIndicatorState('processing')
          return
        }

        clearTimers()
        if (lastState === 'recording' || lastState === 'processing') {
          lastState = 'complete'
          statusText.textContent = 'Text inserted'
          metaText.textContent = lastCharCount > 0 ? `${lastCharCount} chars` : 'done'
          setIndicatorState('complete')
          completeTimer = setTimeout(() => {
            lastState = 'idle'
            hideIndicator()
          }, 900)
        } else {
          lastState = 'idle'
          hideIndicator()
        }
      })

      window.api.onIndicatorFeedback(({ message }) => {
        clearTimers()
        lastState = 'feedback'
        statusText.textContent = message || 'Action blocked'
        metaText.textContent = 'Please stop the current session first.'
        setIndicatorState('processing')
        feedbackTimer = setTimeout(() => {
          lastState = 'idle'
          hideIndicator()
          feedbackTimer = null
        }, 1800)
      })
    </script>
  </body>
</html>
